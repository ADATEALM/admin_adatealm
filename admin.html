<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700;800&display=swap"
        rel="stylesheet">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajawal', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 antialiased font-sans">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex items-center justify-center">
        <div class="text-center">
            <div
                class="w-16 h-16 mx-auto mb-4 bg-brand-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg animate-pulse">
                <i class="fas fa-shield-alt"></i>
            </div>
            <p class="text-gray-600 dark:text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...</p>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="access-denied"
        class="hidden fixed inset-0 bg-gray-50 dark:bg-gray-900 z-40 flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 max-w-md w-full p-8 rounded-3xl shadow-2xl border border-red-100 dark:border-red-900/30 text-center">
            <div
                class="w-20 h-20 mx-auto bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center text-red-600 dark:text-red-400 text-3xl mb-4">
                <i class="fas fa-ban"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6">
                Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….
            </p>
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-xl mb-6">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    <i class="fas fa-info-circle ml-1"></i>
                    Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù…
                </p>
            </div>
            <a href="index.html"
                class="inline-flex items-center gap-2 px-6 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 transition-colors shadow-md">
                <i class="fas fa-home"></i>
                <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
        </div>
    </div>

    <!-- Access Code Screen -->
    <div id="access-code-screen"
        class="hidden fixed inset-0 bg-gray-50 dark:bg-gray-900 z-40 flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 max-w-md w-full p-8 rounded-3xl shadow-2xl border border-brand-100 dark:border-brand-900/30 text-center">
            <div
                class="w-20 h-20 mx-auto bg-brand-100 dark:bg-brand-900/30 rounded-full flex items-center justify-center text-brand-600 dark:text-brand-400 text-3xl mb-4">
                <i class="fas fa-key"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">ÙƒÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6">
                Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </p>
            <form id="access-code-form" class="space-y-4">
                <div>
                    <input type="password" id="access-code-input"
                        class="block w-full p-4 text-center text-lg font-mono rounded-xl border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-colors"
                        placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" required autocomplete="off">
                </div>
                <button type="submit" id="verify-code-btn"
                    class="w-full px-6 py-4 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 transition-all shadow-md text-lg">
                    <i class="fas fa-arrow-left ml-2"></i> ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                </button>
            </form>
            <p id="code-error" class="hidden mt-4 text-sm text-red-600 dark:text-red-400 font-medium">
                <i class="fas fa-exclamation-circle ml-1"></i> ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            </p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-md">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-900 dark:text-white">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                            <p class="text-xs text-gray-500 dark:text-gray-400" id="admin-email">...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="theme-toggle"
                            class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-moon"></i>
                        </button>
                        <a href="index.html"
                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-xl text-sm font-bold transition-colors">
                            <i class="fas fa-arrow-right ml-1"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="space-y-8">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm text-gray-500 dark:text-gray-400">Ø¥Ø«Ø¨Ø§ØªØ§Øª Ù…Ø¹Ù„Ù‚Ø©</h3>
                            <div class="bg-orange-100 dark:bg-orange-900/30 p-2 rounded-lg">
                                <i class="fas fa-clock text-orange-500"></i>
                            </div>
                        </div>
                        <p class="text-3xl font-bold text-orange-500" id="pending-count">0</p>
                    </div>
                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm text-gray-500 dark:text-gray-400">ØªÙ… Ù‚Ø¨ÙˆÙ„Ù‡Ø§</h3>
                            <div class="bg-green-100 dark:bg-green-900/30 p-2 rounded-lg">
                                <i class="fas fa-check-circle text-green-500"></i>
                            </div>
                        </div>
                        <p class="text-3xl font-bold text-green-500" id="approved-count">0</p>
                    </div>
                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                            <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg">
                                <i class="fas fa-users text-blue-500"></i>
                            </div>
                        </div>
                        <p class="text-3xl font-bold text-blue-500" id="total-users">0</p>
                    </div>
                </div>

                <!-- Settings -->
                <div
                    class="bg-gradient-to-br from-brand-50 to-blue-50 dark:from-gray-800 dark:to-gray-700 p-6 rounded-2xl shadow-sm border border-brand-100 dark:border-gray-600">
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-sliders-h ml-2 text-brand-600"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠ ÙˆØ§Ù„Ù†Ù‚Ø§Ø·
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-bullseye ml-1"></i> Ù‡Ø¯Ù Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
                            </label>
                            <input type="number" id="setting-target"
                                class="block w-full p-3 rounded-xl border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm"
                                value="20" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-star ml-1"></i> Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ù„ÙƒÙ„ Ù…Ù†Ø´ÙˆØ±
                            </label>
                            <input type="number" id="setting-points"
                                class="block w-full p-3 rounded-xl border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm"
                                value="10" min="1">
                        </div>
                    </div>
                    <button id="save-settings-btn"
                        class="mt-4 px-6 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 transition-all shadow-md">
                        <i class="fas fa-save ml-1"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    </button>
                </div>

                <!-- Chat Management Section -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft p-6 mb-6 border border-gray-100 dark:border-gray-700">
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-comments text-blue-600"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                    </h2>

                    <div class="space-y-6">
                        <!-- Auto Delete Settings -->
                        <div
                            class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                        <i class="fas fa-clock text-blue-600"></i>
                                        Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
                                    </h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Ø§Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯
                                        ÙØªØ±Ø© Ù…Ø­Ø¯Ø¯Ø©</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="auto-delete-enabled" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-in-600 peer-checked:bg-blue-600">
                                    </div>
                                </label>
                            </div>

                            <div id="auto-delete-options" class="space-y-3">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ù…Ø¯Ø©
                                    Ø§Ù„Ø­Ø°Ù</label>
                                <select id="auto-delete-duration"
                                    class="block w-full p-3 rounded-xl border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white shadow-sm">
                                    <option value="24">ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©</option>
                                    <option value="168">ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹ (7 Ø£ÙŠØ§Ù…)</option>
                                    <option value="720">ÙƒÙ„ Ø´Ù‡Ø± (30 ÙŠÙˆÙ…)</option>
                                    <option value="0">Ø£Ø¨Ø¯Ø§Ù‹</option>
                                </select>

                                <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-2 mt-2">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Ø¢Ø®Ø± ØªÙ†Ø¸ÙŠÙ: <span id="last-cleanup-time">Ù„Ù… ÙŠØªÙ… Ø¨Ø¹Ø¯</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Instant Delete -->
                        <div
                            class="p-4 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-200 dark:border-red-800">
                            <div class="flex items-start gap-4">
                                <div
                                    class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                                    <i class="fas fa-trash-alt text-xl text-red-600 dark:text-red-400"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-900 dark:text-white mb-1">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                        Ø§Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙˆØ±Ø§Ù‹.
                                        <strong class="text-red-600">ØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!</strong>
                                    </p>
                                    <div class="flex items-center gap-3">
                                        <button id="delete-all-messages-btn"
                                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition-colors text-sm">
                                            <i class="fas fa-exclamation-triangle ml-1"></i>
                                            Ø­Ø°Ù Ø§Ù„ÙƒÙ„ ÙÙˆØ±Ø§Ù‹
                                        </button>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">
                                            Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: <strong id="messages-count">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</strong>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="save-chat-settings-btn"
                            class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-md">
                            <i class="fas fa-save ml-1"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                        </button>
                    </div>
                </div>

                <!-- Submissions -->
                <div>
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-tasks ml-2"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
                    </h2>
                    <div id="submissions-list" class="space-y-4">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, increment, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDonGBKsvWjcXYcEYXWUeLxtFwcYTJFDMA",
            authDomain: "admi-c9f65.firebaseapp.com",
            projectId: "admi-c9f65",
            storageBucket: "admi-c9f65.firebasestorage.app",
            messagingSenderId: "708784939336",
            appId: "1:708784939336:web:cfd94d3bd2cb6fa396137d",
            measurementId: "G-Z617ZDGNVP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Admin Emails
        const ADMIN_EMAILS = [
            'adatealm@gmail.com',
            'nourmt01@gmail.com',
            'yacinee474474@gmail.com',
            's22market@gmail.com',
            'adatshifa@gmail.com'
        ];

        function isAdmin(email) {
            return ADMIN_EMAILS.includes(email.toLowerCase());
        }

        // Dark Mode
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        if (localStorage.theme === 'dark') {
            html.classList.add('dark');
            themeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
        }

        themeToggle?.addEventListener('click', () => {
            html.classList.toggle('dark');
            const icon = themeToggle.querySelector('i');
            if (html.classList.contains('dark')) {
                localStorage.theme = 'dark';
                icon.classList.replace('fa-moon', 'fa-sun');
            } else {
                localStorage.theme = 'light';
                icon.classList.replace('fa-sun', 'fa-moon');
            }
        });

        // Auth Check
        const ACCESS_CODE = 'ADATEALMadatealm';
        const CODE_SESSION_KEY = 'adminAccessVerified';

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loading-screen');
            const accessDenied = document.getElementById('access-denied');
            const accessCodeScreen = document.getElementById('access-code-screen');
            const dashboard = document.getElementById('admin-dashboard');

            // Check if user is logged in and is admin
            if (!user || !isAdmin(user.email)) {
                loadingScreen.classList.add('hidden');
                accessDenied.classList.remove('hidden');
                return;
            }

            // User is admin email, now check access code
            const codeVerified = sessionStorage.getItem(CODE_SESSION_KEY) === 'true';

            if (!codeVerified) {
                loadingScreen.classList.add('hidden');
                accessCodeScreen.classList.remove('hidden');
                return;
            }

            // Code verified, show dashboard
            loadingScreen.classList.add('hidden');
            dashboard.classList.remove('hidden');
            document.getElementById('admin-email').innerText = user.email;
            if (input.value === ACCESS_CODE) {
                // Code correct
                sessionStorage.setItem(CODE_SESSION_KEY, 'true');
                document.getElementById('access-code-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                document.getElementById('admin-email').innerText = auth.currentUser.email;
                loadDashboard();
            } else {
                // Code incorrect
                errorMsg.classList.remove('hidden');
                input.value = '';
                input.classList.add('border-red-500');
                setTimeout(() => {
                    errorMsg.classList.add('hidden');
                    input.classList.remove('border-red-500');
                }, 3000);
            }
        });

        async function loadDashboard() {
            try {
                // Load settings
                const settingsDoc = await getDoc(doc(db, "settings", "global"));
                if (settingsDoc.exists()) {
                    const settings = settingsDoc.data();
                    document.getElementById('setting-target').value = settings.weeklyTarget || 20;
                    document.getElementById('setting-points').value = settings.rewardPoints || 10;
                }

                // Load pending submissions
                const q = query(collection(db, "proof_submissions"), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);

                document.getElementById('pending-count').innerText = querySnapshot.size;

                const listContainer = document.getElementById('submissions-list');

                if (querySnapshot.empty) {
                    listContainer.innerHTML = `
                        <div class="text-center text-gray-400 py-12 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700">
                            <i class="fas fa-check-circle text-5xl mb-3 text-green-100 dark:text-green-900"></i>
                            <p class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                        </div>
                    `;
                    return;
                }

                listContainer.innerHTML = '';
                const rewardPoints = parseInt(document.getElementById('setting-points').value) || 10;

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const el = document.createElement('div');
                    el.className = "bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col md:flex-row gap-4 items-start md:items-center justify-between";
                    el.innerHTML = `
                        <div class="flex items-start gap-4 flex-1">
                            <a href="${data.imageUrl}" target="_blank" class="block w-24 h-24 flex-shrink-0 bg-gray-100 dark:bg-gray-700 rounded-xl overflow-hidden relative group">
                                <img src="${data.imageUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" alt="Proof">
                                <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i class="fas fa-search-plus text-white text-xl"></i>
                                </div>
                            </a>
                            <div>
                                <h3 class="font-bold text-gray-900 dark:text-white">${data.username || "User"}</h3>
                                <a href="${data.postLink}" target="_blank" class="text-brand-600 hover:underline text-sm flex items-center gap-1 mt-1">
                                    <i class="fas fa-external-link-alt text-xs"></i> Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†Ø´ÙˆØ±
                                </a>
                                <p class="text-xs text-gray-400 mt-1">${new Date(data.submittedAt?.toDate()).toLocaleDateString('ar-EG')}</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 w-full md:w-auto">
                            <button class="action-btn flex-1 md:flex-none px-4 py-2 bg-green-50 text-green-600 hover:bg-green-600 hover:text-white rounded-xl transition-all font-bold text-sm" data-action="approve" data-id="${docSnap.id}" data-uid="${data.userId}">
                                <i class="fas fa-check ml-1"></i> Ù‚Ø¨ÙˆÙ„ (+${rewardPoints})
                            </button>
                            <button class="action-btn flex-1 md:flex-none px-4 py-2 bg-red-50 text-red-600 hover:bg-red-600 hover:text-white rounded-xl transition-all font-bold text-sm" data-action="reject" data-id="${docSnap.id}">
                                <i class="fas fa-times ml-1"></i> Ø±ÙØ¶
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(el);
                });

                // Event listeners for approve/reject
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const action = btn.dataset.action;
                        const id = btn.dataset.id;
                        const uid = btn.dataset.uid;
                        const parent = btn.closest('.bg-white');

                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        btn.disabled = true;

                        try {
                            const submissionRef = doc(db, "proof_submissions", id);
                            await updateDoc(submissionRef, {
                                status: action === 'approve' ? 'approved' : 'rejected',
                                reviewedAt: new Date(),
                                reviewedBy: auth.currentUser.email
                            });

                            if (action === 'approve') {
                                const pointsToGive = parseInt(document.getElementById('setting-points').value) || 10;
                                const userRef = doc(db, "users", uid);

                                // Get current user data
                                const userDoc = await getDoc(userRef);
                                const currentPoints = (userDoc.data()?.points || 0) + pointsToGive;

                                // Calculate new rank and level
                                const newLevel = Math.floor(currentPoints / 100) + 1;
                                let newRank = 'Ù…ØªØ¯Ø±Ø¨';
                                if (currentPoints >= 5000) newRank = 'Ù‚Ø§Ø¦Ø¯';
                                else if (currentPoints >= 3000) newRank = 'Ù†Ø§Ø¦Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ø¯';
                                else if (currentPoints >= 1500) newRank = 'Ù…Ø´Ø±Ù Ø£ÙˆÙ„';
                                else if (currentPoints >= 500) newRank = 'Ù…Ø´Ø±Ù Ù†Ø´ÙŠØ·';

                                // Update user document with all stats
                                await updateDoc(userRef, {
                                    points: currentPoints,
                                    level: newLevel,
                                    rank: newRank,
                                    "weeklyProgress.count": increment(1),
                                    "stats.approvedSubmissions": increment(1),
                                    "stats.totalPointsEarned": increment(pointsToGive)
                                });

                                console.log(`Approved: +${pointsToGive} points. Total: ${currentPoints}, Level: ${newLevel}, Rank: ${newRank}`);
                            } else {
                                // Update rejection stats
                                const userRef = doc(db, "users", uid);
                                await updateDoc(userRef, {
                                    "stats.rejectedSubmissions": increment(1)
                                });
                            }

                            parent.remove();
                            const newCount = parseInt(document.getElementById('pending-count').innerText) - 1;
                            document.getElementById('pending-count').innerText = newCount;

                        } catch (error) {
                            console.error(error);
                            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
                            btn.innerHTML = action === 'approve' ? 'Ù‚Ø¨ÙˆÙ„' : 'Ø±ÙØ¶';
                            btn.disabled = false;
                        }
                    });
                });

            } catch (error) {
                console.error("Error loading dashboard:", error);
            }
        }

        // Save settings
        document.getElementById('save-settings-btn')?.addEventListener('click', async () => {
            const btn = document.getElementById('save-settings-btn');
            const target = parseInt(document.getElementById('setting-target').value);
            const points = parseInt(document.getElementById('setting-points').value);

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            btn.disabled = true;

            try {
                await setDoc(doc(db, "settings", "global"), {
                    weeklyTarget: target,
                    rewardPoints: points,
                    updatedBy: auth.currentUser.email,
                    updatedAt: new Date()
                });

                btn.innerHTML = '<i class="fas fa-check ml-1"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-save ml-1"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
                }, 2000);
            } catch (error) {
                alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + error.message);
                btn.innerHTML = '<i class="fas fa-save ml-1"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
            }
            btn.disabled = false;
        });

        // ============================================
        // Chat Management Handlers
        // ============================================

        (async () => {
            const { getDatabase, ref: dbRef, remove, onValue } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            const rtdb = getDatabase(app);

            // Load chat settings
            async function loadChatSettings() {
                try {
                    const settingsDoc = await getDoc(doc(db, "settings", "global"));
                    if (settingsDoc.exists()) {
                        const data = settingsDoc.data();
                        const chatSettings = data.chatAutoDelete || {};

                        const enabledCheckbox = document.getElementById('auto-delete-enabled');
                        const durationSelect = document.getElementById('auto-delete-duration');

                        if (enabledCheckbox) enabledCheckbox.checked = chatSettings.enabled || false;
                        if (durationSelect) durationSelect.value = chatSettings.duration || 24;

                        if (chatSettings.lastCleanup) {
                            const lastTime = new Date(chatSettings.lastCleanup.toDate()).toLocaleString('ar-EG');
                            const lastCleanupEl = document.getElementById('last-cleanup-time');
                            if (lastCleanupEl) lastCleanupEl.innerText = lastTime;
                        }
                    }
                } catch (error) {
                    console.error("Error loading chat settings:", error);
                }
            }

            // Count messages
            function updateMessageCount() {
                try {
                    const messagesRef = dbRef(rtdb, 'daily_chat');
                    onValue(messagesRef, (snapshot) => {
                        const count = snapshot.exists() ? snapshot.size : 0;
                        const countEl = document.getElementById('messages-count');
                        if (countEl) countEl.innerText = count;
                    }, { onlyOnce: true });
                } catch (error) {
                    console.error("Error counting messages:", error);
                }
            }

            // Save chat settings
            const saveChatBtn = document.getElementById('save-chat-settings-btn');
            saveChatBtn?.addEventListener('click', async () => {
                const enabled = document.getElementById('auto-delete-enabled')?.checked || false;
                const duration = parseInt(document.getElementById('auto-delete-duration')?.value) || 24;

                saveChatBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                saveChatBtn.disabled = true;

                try {
                    await setDoc(doc(db, "settings", "global"), {
                        chatAutoDelete: {
                            enabled: enabled,
                            duration: duration,
                            lastCleanup: new Date()
                        }
                    }, { merge: true });

                    saveChatBtn.innerHTML = '<i class="fas fa-check ml-1"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸';
                    setTimeout(() => {
                        saveChatBtn.innerHTML = '<i class="fas fa-save ml-1"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©';
                    }, 2000);
                } catch (error) {
                    console.error(error);
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + error.message);
                    saveChatBtn.innerHTML = '<i class="fas fa-save ml-1"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©';
                }
                saveChatBtn.disabled = false;
            });

            // Delete all messages
            const deleteAllBtn = document.getElementById('delete-all-messages-btn');
            deleteAllBtn?.addEventListener('click', async () => {
                const count = document.getElementById('messages-count')?.innerText || '0';

                // First confirmation
                const confirm1 = confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ\n\nØ³ØªÙ‚ÙˆÙ… Ø¨Ø­Ø°Ù ${count} Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`);

                if (!confirm1) return;

                // Second confirmation
                const confirm2 = confirm(`ğŸ”´ ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ!\n\nÙ‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ø£Ø®ÙŠØ±.\nØ³ØªÙØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`);

                if (!confirm2) return;

                deleteAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
                deleteAllBtn.disabled = true;

                try {
                    const messagesRef = dbRef(rtdb, 'daily_chat');
                    await remove(messagesRef);

                    // Update last cleanup time
                    await setDoc(doc(db, "settings", "global"), {
                        'chatAutoDelete.lastCleanup': new Date()
                    }, { merge: true });

                    alert(`âœ… ØªÙ… Ø­Ø°Ù ${count} Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­`);
                    updateMessageCount();
                    await loadChatSettings();
                } catch (error) {
                    console.error(error);
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + error.message);
                }

                deleteAllBtn.innerHTML = '<i class="fas fa-exclamation-triangle ml-1"></i> Ø­Ø°Ù Ø§Ù„ÙƒÙ„ ÙÙˆØ±Ø§Ù‹';
                deleteAllBtn.disabled = false;
            });

            // Initialize chat management if user is admin
            if (auth.currentUser && isAdmin(auth.currentUser.email)) {
                await loadChatSettings();
                updateMessageCount();
            }
        })();
    </script>
</body>

</html>